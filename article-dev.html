<!-- Project Aurora - Blog Framework V3.4 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" type="text/css" href="./css/markdown.css" charset="utf-8"/><!--Markdown样式-->
    <link rel="stylesheet" type="text/css" href="./css/template-dev.css" charset="utf-8"/><!--模板框架样式-->
    <title></title>
    <style>
        .MenuButton {
            font-family: "Material Icons";
            width: 40px;
            height: 40px;
            color: #666;
            background-color: #fff;
            transition: .08s linear;
            border-radius: 50%;
            border: none;
            line-height: 40px;
            text-align: center;
            font-size: 20px;
            z-index: 10000;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!--进度条-->
<div class="progressbar" id="progressbar"></div>

<!--左上：后退按钮-->
<button class="ButtonBack" onclick="window.location.href='./#/articles';">
    <img src="./image/icons/back-gray.png" style="height:16px;width:16px;margin-bottom: 2px;">
</button>

<!--右下：回到顶部按钮-->
<div class="ButtonGoTop" id="ButtonGoTop" onclick="$('html, body').animate({scrollTop:0},'fast');">
    <img src="./image/icons/gotop.png"  style="height:19px;width:17px;">
</div>

<!--右侧：菜单（目录）-->
<div id="MenuContainer" class="MenuContainer">
    <div class="top_sticky">
        <button id="MenuButton" class="MenuButton">menu</button>
        <button class="item_top spa-switch" data-target="index" onclick="window.location.href='.'">首 页</button><button class="item_top spa-switch" data-target="inspiration" onclick="window.location.href='./#/inspiration'">灵 感</button><button class="item_top spa-switch top_active" data-target="articles" onclick="window.location.href='./#/articles'">文 章</button><button class="item_top spa-switch" data-target="links" onclick="window.location.href='./#/links'">书 签</button><button class="item_top spa-switch" data-target="about" onclick="window.location.href='./#/about'">关 于</button>
    </div>
    <div id="contents_list"></div>
</div>

<!--顶部标题（仅移动端显示）-->
<div class="top_title" style="display: none;">
    <div id="top_title" class="title" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"></div>
    <div class="title_bg"></div>
</div>

<!--圆角容器-->
<div class="MainContainer">

    <!--顶部标题和题图-->
    <div id="Cover" class="Cover"></div>
    <div class="md-title">
        <div class="Title" id="Title">⭐</div>
    </div>

    <!--MD内容-->
    <div class="md-content">
        <!--元数据-->
        <div class="md-metadata">
            <span id="metadata-date" style="padding-right:8px;">{日期}</span>·<span id="metadata-author" style="padding-left:8px;">{作者}</span>
        </div>

        <!--正文-->
        <div class="md-mainblock" id="md-mainblock">
            <!--占位符-->
            <span class="loading-content" style="width: 100%;">正在获取正文</span><br>
            <span class="loading-content" style="width: 100%;">0</span><br>
            <span class="loading-content" style="width: 70%;">0</span><br>
        </div>
    </div>

    <!--版权footer-->
    <div class="CopyrightContainer">
        <div class="Copyright RBGradient">☆ Project Aurora ☆</div>
        <div class="Copyright">版权所有 © 2016-<span id="copyright_year">2019</span> Mikukonai</div>
    </div>
</div>

</body>

<!------------------------------------------------------>
<script src="./js/jquery.min.js"></script>
<script src="./js/jquery.easing.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$']]},
    delayStartupUntil: "configured"
});
</script>
<script async src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML&delayStartupUntil=configured"></script>
<script src="./ts/framework/mikumark.js"></script>

<script>

const DURATION = 500;

function Render(mikumark) {
    // 标题
    document.getElementsByTagName("title")[0].innerHTML = `${mikumark.title} / Project Aurora`;
    $('#top_title').html(mikumark.title);
    $('#Title').css('opacity', '0');
    $('#Title').html(mikumark.title);
    $('#Title').animate({'opacity':1.0}, DURATION);

    // 封面
    $('#Cover').css('background-image', `url('${mikumark.cover}')`);

    // 日期
    $('#metadata-date').css('opacity', '0');
    $('#metadata-date').html(mikumark.date.replace(/\-/,"年").replace(/\-/,"月") + '日');
    $('#metadata-date').animate({'opacity':1.0}, DURATION);

    // 作者
    $('#metadata-author').css('opacity', '0');
    $('#metadata-author').html(`作者：${mikumark.authors}`);
    $('#metadata-author').animate({'opacity':1.0}, DURATION);

    // 文章正文
    document.getElementById("md-mainblock").innerHTML = mikumark.HTML;

    // 脚本节点
    let bodyNode = document.getElementsByTagName("body")[0];
    let scriptNode = document.createElement("script");
    scriptNode.innerHTML = mikumark.script;
    bodyNode.appendChild(scriptNode);

    for(let scriptSrc of mikumark.linkedScripts) {
        let scriptNode = document.createElement("script");
        scriptNode.src = scriptSrc;
        bodyNode.appendChild(scriptNode);
    }

    // 样式节点
    let headNode = document.getElementsByTagName("head")[0];
    let styleNode = document.createElement("style");
    styleNode.innerHTML = mikumark.style;
    headNode.appendChild(styleNode);

    for(let styleSrc of mikumark.linkedStyles) {
        let linkStyleNode = document.createElement("link");
        linkStyleNode.setAttribute("rel", "stylesheet");
        linkStyleNode.setAttribute("type", "text/css");
        linkStyleNode.setAttribute("charset", "utf-8");
        linkStyleNode.setAttribute("href", styleSrc);
        headNode.appendChild(linkStyleNode);
    }

    // 版权日期
    if(document.getElementById('copyright_year') !== null) {
        document.getElementById('copyright_year').innerHTML = new Date().getFullYear();
    }
    let years = document.getElementsByClassName('copyright_year');
    for(let i = 0; i < years.length; i++) {
        years[i].innerHTML = new Date().getFullYear();
    }

    // 控制top按钮和菜单按钮的水平位置
    if($(window).width() >= 650) {
        let rightMargin = $(".MainContainer").css("margin-right").match(/^\d+/gi);
        let leftMargin = $(".MainContainer").css("margin-left").match(/^\d+/gi);

        let buttonWidth = $("#ButtonGoTop").css("width").match(/^\d+/gi);
        $("#ButtonGoTop").css("right", (rightMargin - buttonWidth - 30).toString() + 'px');
        let menuButtonWidth = $("#MenuContainer").css("width").match(/^\d+/gi);
        $("#MenuContainer").css("right", (rightMargin - menuButtonWidth - 30).toString() + 'px');

        let backbuttonWidth = $('.ButtonBack').css("width").match(/^\d+/gi);
        $(".ButtonBack").css("left", (leftMargin - backbuttonWidth - 50).toString() + 'px');
    }
    else {
        $("#ButtonGoTop").css("right", '20px');
        $(".ButtonBack").css("left", '0px');
    }

    // body淡入
    $("body").animate({'opacity':1.0}, 1000);

    // 为每张图片注册单击事件
    $('.md_img').each(function(i,e) {
        $(e).click(function() {
            window.open($(e).attr('src'), "_blank");
        });
    });

    // 图片懒加载
    $(document).scroll(function() {
        let top = document.documentElement.scrollTop || document.body.scrollTop;
        let clientHeight = document.documentElement.clientHeight;
        $('.md_img').each(function(i,e) {
            let offsetTop = $(e).offset().top;
            if($(e).attr('src') === undefined) {
                if(offsetTop >= top && offsetTop <= top + clientHeight) {
                    console.log(`开始加载当前视口内未加载的图片：${$(e).attr('data-src')}`);
                    $(e).attr('src', $(e).attr('data-src'));
                    e.onload = ()=>{
                        $(e).parent().children('.loading').fadeOut(500);
                    };
                }
            }
        });
    });

    // 执行一次滚动事件，以触发第一视口的图片懒加载
    $(document).scroll();
}

$(function(){
    // ucs-2 string to base64 encoded ascii
    function utoa(str) {
        return window.btoa(unescape(encodeURIComponent(str)));
    }

    // base64 encoded ascii to ucs-2 string
    function atou(str) {
        return decodeURIComponent(escape(window.atob(str)));
    }

    const MAX_ARTICLE_LENGTH = 64000; // 最大的文章字节数，用于近似计算加载进度

    // 前台路由
    var reqArg = (function getRequestArg() {
        let reqArg = new Object();
        let reqArgStr = window.document.location.href.match(/\?.*$/gi);
        if(reqArgStr !== null) {
            let fields = reqArgStr[0].substring(1).split('&');
            for(field of fields) {
                field = field.replace(/\#.*$/i, ''); // 忽略井号后面的任何字符
                let pair = field.split('=');
                reqArg[decodeURI(pair[0])] = pair[1] ? decodeURI(pair[1]): null;
            }
        }
        return reqArg;
    })();

    if('id' in reqArg) {
        $.ajax({
            type: "GET",
            url: `./markdown/${reqArg.id}.md`,
            success: (data)=> {
                $("#progressbar").animate({width: `100%`});
                $("#progressbar").fadeOut();
                // TODO 此处需要对Mikumark进行彻底重构
                // 文章内容使用base64编码（反爬）
                let b64code = '';
                let lines = data.split('\n');
                for(let i = 0; i < lines.length; i++) {
                    if(lines[i].substring(0,5) === "[B64]") {
                        let key = utoa(prompt('请输入口令'));
                        if(key === 'IA==') { // 半角空格
                            let b64code = lines[i].substring(5);
                            lines[i] = atou(b64code);
                            break;
                        }
                        else {
                            alert('口令不匹配，返回文章列表。');
                            window.history.go(-1);
                            return;
                        }
                    }
                }
                data = lines.join('\n');
                let mikumark = new Mikumark(data);
                Render(mikumark);
                MathJax.Hub.Configured();
            },
            error: ()=> {
                $("#progressbar").animate({width: `100%`});
                $("#progressbar").fadeOut();
                console.error('文章不存在。');
                $('#Cover').css('background-image', `url('./image/70145976_p0.jpg')`);
                $('#Title').html(`文章不存在`);
                setInterval(()=>{
                    // window.location.href = './articles.html';
                }, 1000);
            },
            // 2018.01.20 加载进度条
            xhr: function() {
                var xhr = $.ajaxSettings.xhr();
                xhr.onprogress = function(event) {
                    let percentage = parseInt((event.loaded / MAX_ARTICLE_LENGTH) * 100);
                    $("#progressbar").animate({width: `${((percentage > 100) ? 100 : percentage)}%`});
                };
                return xhr;
            }
        });
    }
    else {
        $("#progressbar").animate({width: `100%`});
        $("#progressbar").fadeOut();
        console.log('加载默认页面。');
        $('#Title').html(`Mikumark Template`);
        setInterval(()=>{
            // window.location.href = './articles.html';
        }, 1000);
    }

});
</script>
</html>
