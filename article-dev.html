<!-- Project Aurora - Blog Framework V3.4 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" type="text/css" href="./css/markdown.css" charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="./css/template-dev.css" charset="utf-8"/>
    <title></title>
</head>
<body>

<!--进度条-->
<div class="Progressbar" id="Progressbar"></div>

<!--顶部标题（仅移动端显示）-->
<div class="StickyTitleContainer" style="display: none;">
    <div id="StickyTitle" class="StickyTitle" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"></div>
    <div class="StickyTitleBackground"></div>
</div>

<!--左边栏-->
<aside class="LeftAside">
    <!--左上：后退按钮-->
    <button id="BackButton" class="Button Raised Round" onclick="window.location.href='./#/articles';">
        <img src="./image/icons/back-gray.png" style="height:16px;width:16px;margin-bottom: 2px;">
    </button>
</aside>


<!--右边栏-->
<aside class="RightAside">
    <!--右侧：菜单（目录）-->
    <div id="MenuContainer" class="MenuContainer">
        <div class="StickyNavbar">
            <button id="MenuButton" class="MenuButton" data-state="off">menu</button>
            <button class="NavbarItem spa-switch InMenu" active="false" data-target="index" onclick="window.location.href='.'">首 页</button>
            <button class="NavbarItem spa-switch InMenu" active="false" data-target="inspiration" onclick="window.location.href='./#/inspiration'">灵 感</button>
            <button class="NavbarItem spa-switch InMenu" active="true"  data-target="articles" onclick="window.location.href='./#/articles'">文 章</button>
            <button class="NavbarItem spa-switch InMenu" active="false" data-target="links" onclick="window.location.href='./#/links'">书 签</button>
            <button class="NavbarItem spa-switch InMenu" active="false" data-target="about" onclick="window.location.href='./#/about'">关 于</button>
        </div>
        <div id="ContentsContainer"></div>
    </div>
    <!--右下：回到顶部按钮-->
    <button id="GoTopButton" class="Button Raised Round" style="position: absolute; bottom: 60px; left: 0;" onclick="$('html, body').animate({scrollTop:0},'fast');">
        <img src="./image/icons/gotop.png"  style="height:19px;width:17px;">
    </button>
</aside>


<!--页面主体-->
<div class="Main">

    <!--标题和封面-->
    <header class="Header">
        <div class="TitleContainer">
            <div class="Title" id="Title" style="opacity: 1;">Loading...</div>
        </div>
    </header>

    <!--导航栏
    <nav class="Navbar">
        <button class="NavbarItem" active="false">首 页</button>
        <button class="NavbarItem" active="false">灵 感</button>
        <button class="NavbarItem"  active="true">文 章</button>
        <button class="NavbarItem" active="false">书 签</button>
        <button class="NavbarItem" active="false">关 于</button>
    </nav>-->

    <!--正文内容-->
    <article class="Article">
        <!--元数据-->
        <div class="MikumarkMetadata">
            <span id="MikumarkMetadataDate" style="padding-right:8px;"></span>·<span id="MikumarkMetadataAuthors" style="padding-left:8px;"></span>
        </div>

        <!--正文-->
        <div class="MikumarkContainer" id="MikumarkContainer">
            <!--占位符-->
            <span class="SkeletonPlaceholder" style="width: 100%;">正在获取正文</span><br>
            <span class="SkeletonPlaceholder" style="width: 100%;">0</span><br>
            <span class="SkeletonPlaceholder" style="width: 70%;">0</span><br>
        </div>
    </article>

    <!--底部-->
    <footer class="Footer">
        <div style="font-size: 13px; text-align: center; line-height: 25px; color: #888888;" class="RBGradient">☆ Project Aurora ☆</div>
        <div style="font-size: 13px; text-align: center; line-height: 25px; color: #888888;">版权所有 © 2016-<span class="CopyrightYear">2019</span> Mikukonai</div>
    </footer>
</div>

</body>

<!------------------------------------------------------>
<script src="./js/jquery.min.js"></script>
<script src="./js/jquery.easing.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$']]},
    delayStartupUntil: "configured"
});
</script>
<script async src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML&delayStartupUntil=configured"></script>
<script src="./ts/framework/mikumark.js"></script>

<script>

const DURATION = 500;
const DEFAULT_COVER = `http://wx4.sinaimg.cn/large/450be1f5gy1g5zjkmhigoj20vy0ht76f.jpg`;

// 一些全局状态

let IS_SCROLLING = false;

// 终端类型判断："PC" or "Mobile"
function GetMediaType() {
    return ($(window).width() >= 650) ? "PC" : "Mobile";
}

// 渲染文章目录
function RenderContents(mikumark) {
    let outline = mikumark.outline;
    let HtmlBuffer = new Array();
    HtmlBuffer.push(`<ul class="ContentsList">`);

    // 保证标签匹配的栈
    let stack = new Array();
    stack.push('{'); // 已经有一个ul了

    for(let i = 0; i < outline.length; i++) {
        let thisLevel = outline[i].level + 1;
        let nextLevel = (outline[i+1] === undefined) ? 2 : (outline[i+1].level + 1)
        let thisTitle = outline[i].title;
        let nextTitle = (outline[i+1] === undefined) ? "" : outline[i+1].title;
        // 缩进
        if(thisLevel < nextLevel) {
            HtmlBuffer.push(`<li><span data-title-id="${i}" id="ContentsItem_${i}" class="ContentsItem">${thisTitle}</span>`);
            stack.push('(');
            for(let c = 0; c < nextLevel - thisLevel; c++) {
                HtmlBuffer.push(`<ul class="ContentsListItem">`);
                stack.push('{');
            }
        }
        // 退出缩进
        else if(thisLevel > nextLevel) {
            HtmlBuffer.push(`<li><span data-title-id="${i}" id="ContentsItem_${i}" class="ContentsItem">${thisTitle}</span>`);
            stack.push('(');
            let count = thisLevel - nextLevel;
            while(count >= 0) {
                if(stack[stack.length-1] === '(') {
                    stack.pop();
                    HtmlBuffer.push(`</li>`);
                }
                else if(stack[stack.length-1] === '{') {
                    if(count > 0) {
                        stack.pop();
                        HtmlBuffer.push(`</ul>`);
                    }
                    count--;
                }
            }
        }
        // 平级
        else {
            HtmlBuffer.push(`<li><span data-title-id="${i}" id="ContentsItem_${i}" class="ContentsItem">${thisTitle}</span></li>`);
        }
    }
    HtmlBuffer.push('</ul>');

    $("#ContentsContainer").html(HtmlBuffer.join(""));

    // 注册目录标题的点击跳转事件
    // 跳转到某个标题
    function TurnTo(titleID) {
        let targetTop = window.pageYOffset + $(`#Title_${titleID}`)[0].getBoundingClientRect().top;
        let currentTop = window.pageYOffset;
        $('html, body').animate({ scrollTop: targetTop-40 }, 200, 'easeOutExpo', () => {
            IS_SCROLLING = false;
            $(window).scroll(); // 保证触发目录刷新
        }); // 照顾顶部sticky导航栏的40px高度
    }
    $(".ContentsItem").each((i, e) => {
        $(e).click((event) => {
            let posterId = $(e).attr("data-title-id");
            IS_SCROLLING = true;
            TurnTo(posterId);
            MenuToggle();
            event.stopPropagation(); // 阻止冒泡
        });
    });
}

///////////////////////////////////////////////////////
//
//  Scroll 触发事件
//
///////////////////////////////////////////////////////

// Scroll 图片懒加载
function ImageLazyLoading() {
    let top = document.documentElement.scrollTop || document.body.scrollTop;
    let clientHeight = document.documentElement.clientHeight;
    $('.md_img').each(function(i,e) {
        let offsetTop = $(e).offset().top;
        if($(e).attr('src') === undefined) {
            if(offsetTop >= top && offsetTop <= top + clientHeight) {
                console.log(`开始加载当前视口内未加载的图片：${$(e).attr('data-src')}`);
                $(e).attr('src', $(e).attr('data-src'));
                e.onload = ()=>{
                    $(e).parent().children('.loading').fadeOut(500);
                };
            }
        }
    });
}

// Scroll 追踪当前标题
function TraceCurrentTitle() {
    // 遍历所有Title，根据当前滚动位置，计算当前所在的章节标题
    function GetVisibleTitle() {
        let titleDOMs = $(".MikumarkTitle");
        let currentTop = window.pageYOffset + 42;
        for(let i = 0; i < titleDOMs.length - 1; i++) {
            let currentTitleTop = window.pageYOffset + titleDOMs[i].getBoundingClientRect().top;
            let nextTitleTop = window.pageYOffset + titleDOMs[i+1].getBoundingClientRect().top;
            if(currentTop > currentTitleTop && currentTop < nextTitleTop) {
                return titleDOMs[i].id;
            }
        }
        return "ContentsItem_0";
    }
    let visibleTitleId = GetVisibleTitle().split("_")[1];;
    $(`.ContentsItem`).removeClass("ContentsItemActive");
    $(`#ContentsItem_${visibleTitleId}`).addClass("ContentsItemActive");
}

// 移动端：控制StickyTitle和GoTop按钮的显示
function ShowOnThreshold() {
    let top = document.documentElement.scrollTop || document.body.scrollTop;
    if(GetMediaType() === "PC") {
        $('.StickyTitleContainer').hide();
        $('#GoTopButton').show();
    }
    else if(GetMediaType() === "Mobile") {
        $('#GoTopButton').hide();
        if(top > 280) {
            $('.StickyTitleContainer').fadeIn(300);
        }
        else {
            $('.StickyTitleContainer').fadeOut(300);
        }
    }
}


///////////////////////////////////////////////////////
//
//  Resize 触发事件
//
///////////////////////////////////////////////////////

// 重新布局按钮
function RearrangeButtonLayout() {
    let buttonWidth = $(".Button").width();

    // 控制左右侧栏的水平位置
    if(GetMediaType() === "PC") {
        let MainRightMargin = $(".Main").css("margin-right").match(/^\d+/gi);
        let MainLeftMargin = $(".Main").css("margin-left").match(/^\d+/gi);

        $(".RightAside").css("right", (MainRightMargin - 30).toString() + 'px');
        $(".MenuContainer").css("right", (MainRightMargin - 30 - buttonWidth).toString() + 'px');

        $(".LeftAside").css("left", (MainLeftMargin - 30 - buttonWidth).toString() + 'px');
    }
    else if(GetMediaType() === "Mobile"){
        $(".RightAside").css("right", String(buttonWidth + 20) + 'px');
        $(".LeftAside").css("left", '0px');
    }
}

// 菜单折叠状态切换
function MenuToggle() {
    let state = $("#MenuButton").attr("data-state");
    if(state === "on") {
        $("#MenuButton").attr("data-state", "off");
        $("#MenuButton").html("menu");
        if(GetMediaType() === "PC") {
            $("#MenuContainer").animate({width: "40px", height: "40px"}, 200, "easeOutExpo");
        }
        else if(GetMediaType() === "Mobile") {
            $("#MenuContainer").animate({width: "40px", height: "40px"}, 200, "easeOutExpo", ()=> {
                $("#MenuContainer").css("background", "transparent");
                $(".NavbarItem").hide();
            });
        }
    }
    else if(state === "off") {
        $("#MenuButton").attr("data-state", "on");
        $("#MenuButton").html("close");
        $(".NavbarItem").show();
        if(GetMediaType() === "PC") {
            $("#MenuContainer").css("border-radius", "20px");
            $("#MenuContainer").animate({width: "400px", height: "600px"}, 200, "easeOutExpo");
        }
        else if(GetMediaType() === "Mobile") {
            $("#MenuContainer").css("background-color", "#ffffff");
            $("#MenuContainer").animate({width: "100%", height: "100%"}, 200, "easeOutExpo");
        }
    }
}

// 在文章渲染之前执行的操作
function BeforeRendering() {
    // 版权日期
    $(".CopyrightYear").each((i, e) => {
        $(e).html(new Date().getFullYear());
    });

    // 菜单按钮的点击事件
    $("#MenuButton").click(() => {
        MenuToggle();
    });

    RearrangeButtonLayout();
    ShowOnThreshold();

}

// 在文章渲染完成之后执行的操作
function AfterRendering() {
    // 穷人版的回调函数：延时1秒等待渲染完成
    setTimeout(() => {
        // body淡入
        // $("body").animate({'opacity':1.0}, 1000);

        // 为每张图片注册单击事件
        $('.md_img').each(function(i,e) {
            $(e).click(function() {
                window.open($(e).attr('src'), "_blank");
            });
        });

        window.onresize = () => {
            RearrangeButtonLayout();
        };

        window.onscroll = () => {
            // 避免跳转时触发图片懒加载，导致跳转目标不正确
            if(IS_SCROLLING !== true) {
                ImageLazyLoading();
                TraceCurrentTitle();
            }
            ShowOnThreshold();
        };

        $(window).scroll();
        $(window).resize();
    }, 200);
}

function Render(mikumark) {
    // 标题
    document.getElementsByTagName("title")[0].innerHTML = `${mikumark.title} / Project Aurora`;
    $('#StickyTitle').html(mikumark.title);
    $('#Title').css('opacity', '0');
    $('#Title').html(mikumark.title);
    $('#Title').animate({'opacity':1.0}, DURATION);

    // 封面
    if(mikumark.cover.length > 0) {
        $('.Header').css('background-image', `url('${mikumark.cover}')`);
    }
    else {
        $('.Header').css('background-image', `url('${DEFAULT_COVER}')`);
    }

    // 日期
    $('#MikumarkMetadataDate').css('opacity', '0');
    $('#MikumarkMetadataDate').html(mikumark.date.replace(/\-/,"年").replace(/\-/,"月") + '日');
    $('#MikumarkMetadataDate').animate({'opacity':1.0}, DURATION);

    // 作者
    $('#MikumarkMetadataAuthors').css('opacity', '0');
    $('#MikumarkMetadataAuthors').html(`作者：${mikumark.authors}`);
    $('#MikumarkMetadataAuthors').animate({'opacity':1.0}, DURATION);

    // 文章正文
    $("#MikumarkContainer").html(mikumark.HTML);

    // 脚本节点
    let bodyNode = document.getElementsByTagName("body")[0];
    let scriptNode = document.createElement("script");
    scriptNode.innerHTML = mikumark.script;
    bodyNode.appendChild(scriptNode);

    for(let scriptSrc of mikumark.linkedScripts) {
        let scriptNode = document.createElement("script");
        scriptNode.src = scriptSrc;
        bodyNode.appendChild(scriptNode);
    }

    // 样式节点
    let headNode = document.getElementsByTagName("head")[0];
    let styleNode = document.createElement("style");
    styleNode.innerHTML = mikumark.style;
    headNode.appendChild(styleNode);

    for(let styleSrc of mikumark.linkedStyles) {
        let linkStyleNode = document.createElement("link");
        linkStyleNode.setAttribute("rel", "stylesheet");
        linkStyleNode.setAttribute("type", "text/css");
        linkStyleNode.setAttribute("charset", "utf-8");
        linkStyleNode.setAttribute("href", styleSrc);
        headNode.appendChild(linkStyleNode);
    }

    // 绘制目录
    RenderContents(mikumark);
}

$(function(){
    // ucs-2 string to base64 encoded ascii
    function utoa(str) {
        return window.btoa(unescape(encodeURIComponent(str)));
    }

    // base64 encoded ascii to ucs-2 string
    function atou(str) {
        return decodeURIComponent(escape(window.atob(str)));
    }

    const MAX_ARTICLE_LENGTH = 64000; // 最大的文章字节数，用于近似计算加载进度

    // 前台路由
    let reqArg = (function getRequestArg() {
        let reqArg = new Object();
        let reqArgStr = window.document.location.href.match(/\?.*$/gi);
        if(reqArgStr !== null) {
            let fields = reqArgStr[0].substring(1).split('&');
            for(field of fields) {
                field = field.replace(/\#.*$/i, ''); // 忽略井号后面的任何字符
                let pair = field.split('=');
                reqArg[decodeURI(pair[0])] = pair[1] ? decodeURI(pair[1]): null;
            }
        }
        return reqArg;
    })();

    BeforeRendering();

    if('id' in reqArg) {
        $.ajax({
            type: "GET",
            url: `./markdown/${reqArg.id}.md`,
            success: (data)=> {
                $("#Progressbar").animate({width: `100%`});
                $("#Progressbar").fadeOut();
                // TODO 此处需要对Mikumark进行彻底重构
                // 文章内容使用base64编码（反爬）
                let b64code = '';
                let lines = data.split('\n');
                for(let i = 0; i < lines.length; i++) {
                    if(lines[i].substring(0,5) === "[B64]") {
                        let key = utoa(prompt('请输入口令'));
                        if(key === 'IA==') { // 半角空格
                            let b64code = lines[i].substring(5);
                            lines[i] = atou(b64code);
                            break;
                        }
                        else {
                            alert('口令不匹配，返回文章列表。');
                            window.history.go(-1);
                            return;
                        }
                    }
                }
                data = lines.join('\n');
                let mikumark = new Mikumark(data);
                Render(mikumark);
                AfterRendering();
                MathJax.Hub.Configured();
            },
            error: ()=> {
                $("#Progressbar").animate({width: `100%`});
                $("#Progressbar").fadeOut();
                console.error('文章不存在。');
                $('#Cover').css('background-image', `url('./image/70145976_p0.jpg')`);
                $('#Title').html(`文章不存在`);
                setInterval(()=>{
                    // window.location.href = './articles.html';
                }, 1000);
            },
            // 2018.01.20 加载进度条
            xhr: function() {
                let xhr = $.ajaxSettings.xhr();
                xhr.onprogress = function(event) {
                    let percentage = parseInt((event.loaded / MAX_ARTICLE_LENGTH) * 100);
                    $("#Progressbar").animate({width: `${((percentage > 100) ? 100 : percentage)}%`});
                };
                return xhr;
            }
        });
    }
    else {
        $("#Progressbar").animate({width: `100%`});
        $("#Progressbar").fadeOut();
        console.log('加载默认页面。');
        $('#Title').html(`Mikumark Template`);
        setInterval(()=>{
            // window.location.href = './articles.html';
        }, 1000);
    }

});
</script>
</html>
