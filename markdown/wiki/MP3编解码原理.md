#!title:    MP3编解码原理
#!date:     2019-11-03
#!authors:  Mikukonai
#!cover:    
#!type:     C
#!tags:     

#!{ImagePath}:./image/wiki/C/mp3

#!content

> 正在调查研究。本文是学习成果的记录。

# 待整理的笔记

## 分析子带滤波器组（20191104）

分析子带滤波器组，用于编码器。

首先明确输入和输出形式。对于每帧1152采样，划分成36组长度为32点的采样段，将每段**分别**输入滤波器，执行36次32点子带滤波，得到长度为32的滤波后结果。则36个采样段可以得到36组长度为32的滤波后结果。

滤波后结果的每一点对应32个子带之一，所以换一个视角，子带滤波器组的输出结果是：32个长度为36的子带滤波结果，每个结果对应一个频带。

至于子带滤波器，它的信号流图以及算法参数都在11172标准中有定义，直接照抄就可以。

![信号流图](http://wx3.sinaimg.cn/large/450be1f5gy1g8m3hdg4tgj23342bcjzo.jpg)

## 心理声学模型如何控制码率分配（20191105）

+ 量化会引入量化噪声，包括同时噪声，也包括前回声（尤其是长窗口MDCT情况下）。
+ 人耳存在掩蔽效应，凡是低于掩蔽门限的声音，都是无法察觉的。掩蔽信号（Masker）与其某个掩蔽门限之比，称为信掩比（SMR）。
+ 量化位数越多，精度越高，量化噪声越低，即信噪比（SNR）越高，代价是码率开销越大。
+ 因此，对于某个信号，在某个量化精度下，如果其量化噪声恰好低于掩蔽门限，则量化噪声无法察觉，那么此时的量化精度就刚刚好，再提高量化精度也没有感知上的意义了。
+ 定义掩噪比MNR=SNR-SMR（标准如此），显然，如果某个量化位数使得MNR等于0，则此量化位数就是能够不引起可察觉量化失真的最低位数。
+ 编码器通过内部的循环，确定每帧的最佳量化位数，以实现VBR。

# 研究动机和目标

MP3音频编码标准，自从上个世纪80年代末提出至今，已经有三十余年的历史了。MP3是第一个针对“宽带”音频的压缩编码标准，在此之前的技术大多是针对语音压缩而提出的。MP3发展至今，已经一统江湖，成为最流行的数字音频压缩标准，没有之一；“MP3”这个词，俨然成为数字音乐的代名词。由于我本人对于音响技术一直很感兴趣，再加上近期知识管理工作中对于MP3文件管理的客观需要，都需要对MP3编解码原理做一些深入的研究，直至实现最基本的编解码器原型。

MP3编码标准所使用的技术，包括子带滤波、心理声学模型、变换编码和熵编码，都是非常具有代表性的技术，横跨众多领域，奠定了众多后续技术的基础。包括AAC、AC-3、MP3Pro等更为先进的音频编解码技术，都与MP3有着类似的思路。因此，掌握MP3标准之后再学习其他更为先进的标准，就轻松多了。

经过这段时间的研究，我的观念有所变化。那就是在个人数据管理工作中，一味追求无损是没有意义的。无损PCM相比于320K的MP3，并不会带来多高的音质提升，却浪费了几倍的空间，实在是不值当。这与高清视频不同：大尺寸、高帧率、高位深，是肉眼能实实在在感受到的。所以，以后不必一味追求PCM无损，省下来的空间多保存一些4K乃至8K的超高清视频，这是更划算的。

# MP3标准概述

全称 MPEG-1 Layer Ⅲ，对应国际标准为 ISO/IEC 11172-3。

![MP3编码器框图[2.0]]({ImagePath}/mp3-encoder-diagram.png)

# 心理声学模型

以下暂且翻译11172标准的附录D。

## 1.第一心理声学模型

心理声学模型的计算，应当根据标准层的不同而作调整。下面的例子适用于第一层和第二层，也可以用于第三层（MP3）。

第一层和第二层使用的第一心理声学模型并无原理上的不同。

- 第一层：每个数据块（12个子带，即384个PCM输入采样）计算一次比特分配。
- 第二层：每三个数据块（36个子带，即1152个PCM输入采样）计算一次比特分配。

为了计算全部32个子带的比特分配，必须先计算出每个子带的信掩比（SMR）。因此，有必要确定每个子带的最大声压级和最小的掩蔽门限。其中，最小掩蔽门限是将输入的PCM信号作FFT之后，根据心理声学模型计算得到的。

FFT与子带滤波并行进行，可补偿子带滤波器组在低频频段上缺乏频谱选择性的问题。这一手段既可以提供足够的时间分辨率（多相滤波器的窗口经过优化，可使前回声现象最小化），也为掩蔽门限的计算提供了足够的频谱分辨率。

在编解码过程中，可以计算出混叠失真的频率和幅度。解码过程中，对于那些需要一些比特以消除混叠成分的子带来说，计算出混叠失真的频率或者幅度，以计算出最小比特率，是非常必要的。只有在编码器中才需要引入更多的计算复杂度，以提升频率分辨率，而在解码器中则并不需要。

可采取以下步骤，计算信掩比：

+ 计算FFT，将时域信号变换到频域。
+ 计算每个子带的声压级。
+ 计算绝对听阈。
+ 找出单音性和非单音性（噪音性）的音频信号成分。
+ 抽取最相关的掩蔽信号（masker）。
+ 计算每个掩蔽信号的掩蔽门限。
+ 计算全局掩蔽门限。
+ 计算每个子带的最小掩蔽门限。
+ 计算每个子带的SMR。

下文将以48kHz采样率为例，详细介绍以上过程。对于其余两个采样率，需要相应调整下文涉及到的频率数值。

### 第一步：快速傅里叶变换

掩蔽门限是由信号功率密度谱的估计值计算得来。其中，功率密度谱由输入PCM信号的512点（第一层）或1024点（第二层、第三层）FFT计算得到。在计算FFT之前，需要对输入信号加汉宁（Hann）窗。

为了使比特分配和相应的子带采样在时间上保持一致，PCM采样数据进入FFT之前必须先作延时处理：

+ 分析子带滤波器的延迟是256个采样点，在48kHz采样率下相当于5.3ms。这相当于256个样本的窗口移位。
+ 汉宁窗窗口必须与数据帧的子带采样对齐。对于第一层是移动窗口+64个采样，而对于第二层是移动窗口-64个采样。

FFT的相关参数：

|    |第一层|第二层|
|----------------|
|点数|512|1024|
|相应的窗宽(44.1kHz)|11.6ms|23.2ms|
|频率分辨率|采样率/512|采样率/1024|

汉宁窗：

$$ h(i) = 0.5 * (1 - \cos(2 \pi \frac {i}{N-1} ) ) \quad , \quad 0 \le i \lt N $$

功率密度谱：（公式有问题，暂且放过）

需要对参考声压级作标准化，以使最大声压级等于96dB。

### 第二步：计算声压级

使用下式计算子带n的声压级$L_{sb}(n)$：

$$ L_{sb}(n) = \mathrm{max}(X(k), 20 \log (scfmax(n) \cdot 32768 ) - 10 ) \mathrm{dB}$$

X(k) in 子带n

式中，X(k)是子带n范围内幅度最大的那条谱线的声压级。scfmax(n)指的是第一层的尺度因子（scalefactor），或者第二层的一帧中子带n的三个尺度因子中的最大值。“-10dB”项用于校正峰值电平和RMS电平之间的差异。对每个子带，都会计算出一个声压级$L_{sb}(n)$。

## 2.第二心理声学模型

第二心理声学模型是一个独立的心理声学模型，可以对其进行调整并适用于ISO-MPEG音频编码的每一层。本附录介绍一般的第二心理声学模型，并为实现用于第一层和第二层编码的声学模型提供了足够的信息。第三层编码的第二心理声学模型也基于此实现，但是会有一些调整，具体内容在附录C中描述。

第二心理声学模型的阈值计算过程有3个输入，它们是：

1、位移长度iblen，介于(384,640)之间。在每一个具体的计算过程中，iblen的值必须保持不变。如果需要以两个不同的位移长度执行两个阈值计算（如第三层），则每个计算过程都需要指定一个固定不变的位移长度。






舍弃人耳无法感知的冗余信息：声压级（SPF），听阈（静音门限）和痛阈，时域掩蔽和频域掩蔽，关键频带（critical bands），第二心理声学模型，信掩比（SMR）

![安静环境下的绝对听阈[4.0]]({ImagePath}/mp3-absolute-threshold-of-hearing.png)

![理想化的关键频带划分示意图[4.0]]({ImagePath}/mp3-critical-bands.png)

![频域（同时）掩蔽，以及NMR、SNR、SMR之间的关系示意[1.2(由[2.0重制])]]({ImagePath}/mp3-simultaneous-masking.png)

![时域掩蔽[1.2(由[2.0重制])]]({ImagePath}/mp3-temporal-masking.png)


# 滤波与变换编码

子带滤波器组，改进的离散余弦变换（MDCT），长窗口和短窗口，前回声抑制

![分析子带滤波器组的频率特性[2.0]]({ImagePath}/mp3-filterbank.png)

![MDCT使用的四种窗口[2.0]]({ImagePath}/mp3-MDCT-windows.png)

![混叠消除的蝴蝶结运算[1.0]]({ImagePath}/mp3-aliasing-butterfly.png)

# 量化与熵编码

非均匀量化，Huffman编码

# 编码参数与码率控制

CBR/ABR/VBR，码率控制环路

# 比特流结构

ID3v2等

# 现有的编解码器产品

LAME

# 附录

## WAV文件格式

WAVE文件格式是RIFF格式的其中一种，一般用来存储PCM音频数据，也可以存储其他格式。以下是典型的WAV文件布局。

![WAV文件格式]({ImagePath}/wav-format.png)

- 标红的部分是固定不变的部分。
- 所有数值字段均为小端模式，即高位字节在高地址，低位字节在低地址。
- 格式块字节数：指的是fmt块（蓝色）除了前两个字段以外的其余部分的字节数，固定为16。
- 音频格式：固定为1，代表PCM。
- 声道数：1为单声道；2为双声道。
- 采样率：指每秒钟PCM采样数。
- 每秒字节数：等于采样率×每个采样的字节数。
- 采样字节数：每个采样的字节数，包含所有声道，等于采样位深×声道数÷8。
- 采样位深：每个声道每个采样的位数，一般为8、16。
- 数据块字节数：即所有PCM数据的总的字节数。
- 0x24处可能有一可选块“fact”，PCM格式中一般不会出现。

# 参考资料

**说明**：首先推荐一个MP3资料收集网站，有许多论文和技术资料可供下载：[http://www.mp3-tech.org/]()。以下参考资料中，凡是此网站有收录，或者很容易找到的，不再给出链接；不太容易找到的，将给出链接，方便读者溯源。部分文献资料可联系本文作者索取。

标准文档及其相关解读，标准文档当然是最高依据：

- [1.0] **ISO/IEC 11172** - Coding Of Moving Picture And Associated Audio For Digital Storage Media At Up To About 1,5 Mbit/s - Part 3: Audio
- [1.1] Pan D . **Tutorial on MPEG/audio compression**[J]. IEEE Multimedia, 1995, 2(2):60-74.
- \[1.2] Noll, P. [**MPEG digital audio coding**](https://www.csd.uoc.gr/~hy438/lectures/MPEGAudioCoding.pdf)[J]. IEEE Signal Process Mag, 1997, 14(5):59-81.

较好的中文论文，原理与实现并重，可供快速入门：

- [2.0] 張芷燕. **MP3編碼法之研究與實現**[D]. 国立交通大学（台湾省）, 2002.
- \[2.1] 丰帆. [**MP3数字音频编解码算法的研究及实现**](http://www.doc88.com/p-1854633481570.html)[D]. 西安电子科技大学, 2008.
- [2.2] 王建昕, 董在望. **MPEG音频编码算法的研究与实时实现**[J]. 清华大学学报(自然科学版), 1997(10):45-48.

适合入门的科普向文章：

- [3.0] Rassol Raissi. **The Theory Behind Mp3**

有关感知音频编码基本原理的文章，可供参考：

- [4.0] Painter T , Spanias A . **Perceptual coding of digital audio**[J]. Proceedings of the IEEE, 2000, 88(4):451-515.

有关人类听觉系统的文章，或许有用：

- [5.0] D Robinson. **The Human Auditory System**

随着研究的继续，本列表会不断更新。
