#!metadata
{
    "title":"硬件备忘录",
    "titleImage":"./image/cover/open-source.jpg",
    "type":"原创",
    "date":"2019-03-16",
    "author":["Mikukonai"],
    "tags":[]
}

#!content

# 水晶头线序（2018-12-28）

以触点所在的那面为正面。

||1|2|3|4|5|6|7|8|
|---------------|
|B|[[#ff8800:◑#]]|[[#ff8800:●#]]|[[#00bb00:◑#]]|[[#0000ff:●#]]|[[#0000ff:◑#]]|[[#00bb00:●#]]|[[#995500:◑#]]|[[#995500:●#]]|
|A|[[#00bb00:◑#]]|[[#00bb00:●#]]|[[#ff8800:◑#]]|[[#0000ff:●#]]|[[#0000ff:◑#]]|[[#ff8800:●#]]|[[#995500:◑#]]|[[#995500:●#]]|

------

# 树莓派（2017-02-13）

## 中文设置

[http://shumeipai.nxez.com/2016/03/13/how-to-make-raspberry-pi-display-chinese.html]()
```
sudo apt-get install ttf-wqy-zenhei
sudo apt-get install scim-pinyin
```
然后设置locale。

## 树莓派3代串口设置

执行下列命令：
```
sudo apt-get update
sudo apt-get upgrade
```
然后，安装串口工具minicom：
```
sudo apt-get install minicom
```
一切就绪。现在开始配置树莓派方面的串口。

### 一、树莓派串口配置

#### 1. 关闭串口控制台

首先，修改`/boot/cmdline.txt`，将含有`console=<关于串口的>`删掉，关闭串口控制台。

#### 2. 将硬件串口绑定到GPIO

查看`/boot/overlays/`目录下有没有`pi3-miniuart-bt-overlay.dtb`这个文件，如果没有，[下载](http://ukonline2000.com/?attachment_id=881)。

然后修改`/boot/cmdline.txt`，添加
```
dtoverlay=pi3-miniuart-bt-overlay
force_turbo=1
```

#### 3. 关闭板载蓝牙模块

由于树莓派的硬件串口被蓝牙模块占用，因此需要解除占用。首先输入
```
sudo systemctl disable hciuart
```
关闭hciuart。

然后编辑`/lib/systemd/system/hciuart.server`将 “serialX”修改为“ttyS0”。

#### 4. 关于串口设备文件的名字

实际上目前的Raspbian中串口文件是`/dev/serial0`，有文章指出树莓派还有一个软串口miniuart，不知道serial0和ttyAMA0之间是什么关系。在此不予深究，反正就是使用`/dev/serial0`就可以。

### 二、硬件连线

如果安装了wiringPi的话，输入
```
gpio readall
```
可以查看串口对应的硬件引脚。一般来说，物理引脚6、8、10分别对应GND、TxD、RxD。

需要注意，Arduino是5V电平（据说是，我也不知道），树莓派是3V3电平，因此必须使用电平转换芯片，或者其他匹配措施。我使用的是TXS0108E电平转换芯片，有一个使能端OE，需要接3V3高电平使能。

### 三、树莓派端串口操作

我使用了一款GPS接收模块，默认波特率为9600，以1Hz的频率从串口输出NMEA协议数据。

树莓派端执行`sudo minicom -s`，设置串口文件为`/dev/serial0`，波特率9600，软硬件流量控制都关掉。保存为dfl（默认），Exit回到minicom，正常情况下树莓派这边应该能收到串口数据。

## 树莓派与电脑共享Internet

操作系统是官方Raspbian。下文中，树莓派的IP固定为192.168.0.3/24，网关（路由器）为192.168.0.1，校园网的DNS是101.7.8.9和121.248.60.11。

## 网络共享

条件所限，笔记本电脑无线网卡用来连接外网，以太网口用来连接树莓派。

Windows 10 上，打开【控制面板】-【网络连接】，右键选择无线网卡，在属性的【共享】选项卡中将网络共享给以太网。

以太网卡方面，手动设置其IP为192.168.0.1/24，默认网关192.168.0.1，手动设置DNS为101.7.8.9和121.248.60.11，即可。

Windows XP 上，差不多的步骤，但需要注意一点是，开启无线网卡共享后，以太网的IP会被自动设置，确认后重新设置即可。

Ubuntu14.04 上（没有试过），先放在这里。

## 树莓派静态IP设置

首先修改/etc/network/interfaces，将`iface eth0 inet manual`改成`static`，添加一些内容，结果如下：
```
iface eth0 inet static
address 192.168.0.3
netmask 255.255.255.0
gateway 192.168.0.1
dns-nameservers 101.7.8.9 121.248.60.11
```
正如文件中的提示所说，只修改这个文件还不够，还需要修改/etc/dhcpcd.conf，添加以下内容：
```
# static ip config
interface eth0
static ip_address=192.168.0.3/24
static routers=192.168.0.1
static domain_name_servers=101.7.8.9
```
存退，重启机器即可。

## 服务器搭建

执行
```
sudo apt-get install nginx
sudo apt-get install php5-fpm
sudo apt-get install php5-sqlite
```
之前最好update一下。
另，软件源推荐使用USTC的软件源，比较靠谱。

然后将
/etc/nginx/sites-available/default
的PHP部分改成：
```
# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
#
location ~ \\\\\\\\\\\\\\\\.php$ {
    include snippets/fastcgi-php.conf;
    # With php5-cgi alone:
    # fastcgi_pass 127.0.0.1:9000;
    # With php5-fpm:
    fastcgi_pass unix:/var/run/php5-fpm.sock;
}
```
启用PHP5。

有的时候，使用exec()之类的函数执行系统命令行，需要为我们的cgi设置超级用户权限。尽管为安全起见，并不推荐这么做，但考虑到开发需要，我们可以在`/etc/sudoers`里面适当位置加上这样一行
```
www-data ALL=(ALL:ALL) NOPASSWD:ALL
```
即可赋予PHP以执行sudo命令的权限。

此时，在（默认的）`/var/www/html`目录下新建index.php并添加其内容
```
<?php
    phpinfo();
?>
```
然后用浏览器访问该页，如果输出php相关的内容，说明配置成功。

本节参考资料

+ [http://www.cnblogs.com/wjne/p/3753788.html]()

## 修改开机启动信息

```
/etc/motd
```
## vncserver开机自启动

[http://shumeipai.nxez.com/2013/09/04/login-rpi-with-vnc.html?variant=zh-cn]()

------

# Edison（2017-03-11）

首先，安装驱动并更新固件：

连接usb client（拨动开关下面的那个）至电脑，SSH登录Edison，ip地址一般是192.168.2.15。也可以利用无线网登录。

然后，利用wpa_cli连接wlan，步骤如下（[http://www.360doc.com/content/12/1231/11/9298584_257299004.shtml]()）：
```
 > add_network（返回X）
 > set_network X ssid "<你的AP的SSID>"
 > set_network X psk "<你的AP的密码>"
 > enable_network X
 > save_config
 > quit
```
添加软件仓库：
修改`cat /etc/opkg/base-feeds.conf`为

```
src/gz all http://repo.opkg.net/edison/repo/all
src/gz edison http://repo.opkg.net/edison/repo/edison
src/gz core2-32 http://repo.opkg.net/edison/repo/core2-32
```

安装必要软件：

```
opkg update
opkg install lighttpd-module-cgi
opkg install lighttpd-module-scgi
opkg install lighttpd-module-fastcgi
opkg install nodejs-npm
opkg install sqlite3
opkg install php
以及apache2等
```

## 世界上最好的编程语言+lighttpd配置

参考[http://blog.csdn.net/unix21/article/details/8567446]()

修改`/etc/lighttpd.conf`，加入

```
server.modules += ( "mod_fastcgi" )
fastcgi.server = ( ".php" =>
  (( "socket" => "/tmp/php-fastcgi.socket",
    "bin-path" => "/usr/bin/php-cgi",
     "min-procs" => 1,
     "max-procs" => 1,
     "max-load-per-proc" => 4,
     "bin-environment" => (
     "PHP_FCGI_CHILDREN" => "2",
        "PHP_FCGI_MAX_REQUESTS" => "10000" ),
      "bin-copy-environment" => (
        "PATH", "SHELL", "USER" ),
      "broken-scriptfilename" => "enable",
     "idle-timeout" => 20
  ))
)
```

## 解决Python requests安全连接问题

[http://stackoverflow.com/questions/29134512/insecureplatformwarning-a-true-sslcontext-object-is-not-available-this-prevent]()

执行`pip install requests[security]`

## 使用Arduino扩展底板时，其上引出的IIC是归属于Linux的`/dev/i2c-6`设备文件。

## 参考资料

市面上唯一能找到的中文书籍：《Intel Edison智能硬件开发指南》

## 有用的链接

- [https://github.com/cheaven/edison_native]()
- [http://www.dfrobot.com.cn/community/thread-12877-1-1.html]()

## 串口设置

> 本节参考
[https://communities.intel.com/thread/57321]()
[http://www.arduino.cn/thread-12344-1-1.html]()
[https://communities.intel.com/thread/54236]()

使用Arduino扩展板的话，串口（Arduino 0、1）对应的设备文件是`/dev/ttyMFD1`，但是直接使用是不行的。执行下列命令：

```
echo 214 > /sys/class/gpio/export 2>&1
echo high > /sys/class/gpio/gpio214/direction
echo low > /sys/class/gpio/gpio214/direction
echo 131 > /sys/class/gpio/export 2>&1
echo mode1 > /sys/kernel/debug/gpio_debug/gpio131/current_pinmux
echo 249 > /sys/class/gpio/export 2>&1
echo high > /sys/class/gpio/gpio249/direction
echo 1 > /sys/class/gpio/gpio249/value
echo 217 > /sys/class/gpio/export 2>&1
echo high > /sys/class/gpio/gpio217/direction
echo 1 > /sys/class/gpio/gpio217/value
echo out > /sys/class/gpio/gpio131/direction
echo 0 > /sys/class/gpio/gpio131/value
echo 130 > /sys/class/gpio/export 2>&1
echo mode1 > /sys/kernel/debug/gpio_debug/gpio130/current_pinmux
echo 248 > /sys/class/gpio/export 2>&1
echo low > /sys/class/gpio/gpio248/direction
echo 0 > /sys/class/gpio/gpio248/value
echo 216 > /sys/class/gpio/export 2>&1
echo in > /sys/class/gpio/gpio216/direction
echo in > /sys/class/gpio/gpio130/direction
echo high > /sys/class/gpio/gpio214/direction
```

原理估计是控制扩展板上的一堆多路开关，使核心板的串口引脚连接到Arduino 0、1数字引脚上。

然后，控制安信可A6模块，通过串口向其发送AT指令。注意，系列指令的每条指令之间最好有1秒的延时。另外，使用A6模块时，由于A6模块耗电量较大，必须用交流电源适配器对Edison板子供电。

```:C
...
char CMGF[12] = "AT+CMGF=0\r\n";
char CMGS[13] = "AT+CMGS=<编码器计算出的短信长度>\r\n";
char text[74] = "<经PDU编码的短信内容>\x1a";
int cntr = 1;
while(cntr > 0) {
    write(fd, CMGF, strlen(CMGF));
    sleep(2);
      read(fd, buff, 64);printf("[sms]%s\n", buff);
    write(fd, CMGS, strlen(CMGS));
    sleep(2);
      read(fd, buff, 64);printf("[sms]%s\n", buff);
    write(fd, text, strlen(text));
    sleep(2);
      read(fd, buff, 64);printf("[sms]%s\n", buff);
    cntr--;
}
...
```

------

# NodeMCU（2017-02-11）

## 硬件连线

![NodeMCU端口与ESP12的连接关系](./image/esp8266/ports.png)

![NodeMCU原理图](./image/esp8266/schematic.png)

## 端口编号

|NodeMCU编号|ESP模块编号|Arduino编号|备注|
|------|
|D0|GPIO16|16|下拉使能板载LED|
|D1|GPIO5|5||
|D2|GPIO4|4||
|D3|GPIO0|0|带3V3上拉|
|D4|GPIO2|2|带3V3上拉|

## I2C配置

只有D3、D4可以方便地设置为I2C总线，因其带有上拉电阻。尽管其他端口均可通过软件设置为I2C总线，但是需要外部上拉。

使用以下Arduino函数设置I2C总线：
```
begin(SDA=0, SCL=2)
```

即，默认D3接器件的SDA，D4接器件的SCL。


#!css

#!js
